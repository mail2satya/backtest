<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Chart Viewer</title>
    <!-- Include Plotly.js from a CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 40px auto; max-width: 800px; line-height: 1.6; color: #333; }
        h1 { text-align: center; }
        .search-container { position: relative; margin-bottom: 20px; }
        #stock-search { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
        #suggestions { position: absolute; border: 1px solid #ddd; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; }
        #suggestions div { padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #ddd; }
        #suggestions div:hover { background-color: #f1f1f1; }
        #chart { width: 100%; height: 500px; }
        #selected-symbols-container { margin-bottom: 15px; }
        #selected-symbols-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        #selected-symbols .symbol-tag { display: inline-flex; align-items: center; padding: 5px 10px; background-color: #e0e0e0; border-radius: 15px; margin-right: 5px; margin-bottom: 5px; font-size: 14px; }
        #selected-symbols .close-btn { margin-left: 8px; border: none; background: #bbb; color: white; border-radius: 50%; width: 18px; height: 18px; line-height: 18px; text-align: center; cursor: pointer; font-size: 12px; padding: 0; }
        #selected-symbols .close-btn:hover { background: #999; }
        #clear-chart { padding: 8px 12px; border: none; background-color: #f44336; color: white; border-radius: 5px; cursor: pointer; }
        #clear-chart:hover { background-color: #d32f2f; }
    </style>
</head>
<body>
    <h1>Stock Chart Viewer</h1>
    <div class="search-container">
        <input type="text" id="stock-search" placeholder="Type a stock symbol (e.g., TCS)...">
        <div id="suggestions"></div>
    </div>

    <div id="selected-symbols-container">
        <div id="selected-symbols"></div>
        <button id="clear-chart" style="display:none;">Clear Chart</button>
    </div>

    <div id="chart"></div>

    <script>
        const searchInput = document.getElementById('stock-search');
        const suggestionsContainer = document.getElementById('suggestions');
        const selectedSymbolsContainer = document.getElementById('selected-symbols');
        const clearChartBtn = document.getElementById('clear-chart');
        const chartDiv = document.getElementById('chart');

        let plottedSymbols = [];

        // Debounce function to limit API calls
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function updateSelectedSymbolsUI() {
            selectedSymbolsContainer.innerHTML = '';
            plottedSymbols.forEach(symbol => {
                const tag = document.createElement('div');
                tag.className = 'symbol-tag';
                // Use the times symbol for a better 'x'
                tag.innerHTML = `<span>${symbol}</span><button class="close-btn" data-symbol="${symbol}">&times;</button>`;
                selectedSymbolsContainer.appendChild(tag);
            });
            clearChartBtn.style.display = plottedSymbols.length > 0 ? 'inline-block' : 'none';
        }

        // Function to fetch and display the chart(s)
        async function plotChart() {
            if (plottedSymbols.length === 0) {
                Plotly.purge(chartDiv);
                updateSelectedSymbolsUI();
                return;
            }

            const traces = [];
            let layout;
            const config = { scrollZoom: true };

            try {
                if (plottedSymbols.length === 1) {
                    // Single stock: Plot candlestick chart
                    const symbol = plottedSymbols[0];
                    const response = await fetch(`/api/ohlc?symbol=${symbol}`);
                    const data = await response.json();

                    if (data.length > 0) {
                        traces.push({
                            x: data.map(d => d.timestamp),
                            open: data.map(d => d.open),
                            high: data.map(d => d.high),
                            low: data.map(d => d.low),
                            close: data.map(d => d.close),
                            type: 'candlestick', name: symbol
                        });
                    }
                    layout = {
                        title: `${symbol} Candlestick Chart`,
                        xaxis: { title: 'Date', rangeslider: { visible: false } },
                        yaxis: { title: 'Price' },
                        dragmode: 'pan'
                    };

                } else {
                    // Multiple stocks: Plot percentage change line chart
                    for (const symbol of plottedSymbols) {
                        const response = await fetch(`/api/ohlc?symbol=${symbol}`);
                        const data = await response.json();
                        if (data.length > 0) {
                            const basePrice = data[0].close;
                            traces.push({
                                x: data.map(d => d.timestamp),
                                y: data.map(d => ((d.close / basePrice) - 1) * 100),
                                type: 'scatter', mode: 'lines', name: symbol
                            });
                        }
                    }
                    layout = {
                        title: `Stock Price % Change Comparison`,
                        xaxis: { title: 'Date' },
                        yaxis: { title: '% Change' },
                        dragmode: 'pan',
                        showlegend: true
                    };
                }

                if (traces.length === 0) {
                    chartDiv.innerHTML = `<p>No data found for selected symbols.</p>`;
                    return;
                }

                Plotly.newPlot(chartDiv, traces, layout, config);
                updateSelectedSymbolsUI();

            } catch (error) {
                console.error('Error fetching chart data:', error);
                chartDiv.innerHTML = '<p>Error loading chart data.</p>';
            }
        }

        // Function to handle search input
        const onSearchInput = async (event) => {
            const query = event.target.value;
            suggestionsContainer.innerHTML = '';

            if (query.length < 2) return;

            try {
                const response = await fetch(`/api/search?q=${query}`);
                const suggestions = await response.json();

                suggestions.forEach(symbol => {
                    const div = document.createElement('div');
                    div.textContent = symbol;
                    div.addEventListener('click', () => {
                        searchInput.value = ''; // Clear search input
                        suggestionsContainer.innerHTML = '';
                        if (plottedSymbols.length < 3 && !plottedSymbols.includes(symbol)) {
                            plottedSymbols.push(symbol);
                            plotChart();
                        } else if (plottedSymbols.length >= 3) {
                            alert("You can compare a maximum of 3 symbols.");
                        }
                    });
                    suggestionsContainer.appendChild(div);
                });
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        };

        clearChartBtn.addEventListener('click', () => {
            plottedSymbols = [];
            Plotly.purge(chartDiv);
            updateSelectedSymbolsUI();
        });

        searchInput.addEventListener('input', debounce(onSearchInput, 300));

        selectedSymbolsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('close-btn')) {
                const symbolToRemove = event.target.dataset.symbol;
                plottedSymbols = plottedSymbols.filter(s => s !== symbolToRemove);
                plotChart();
            }
        });

        document.addEventListener('click', (event) => {
            if (!suggestionsContainer.contains(event.target) && event.target !== searchInput) {
                suggestionsContainer.innerHTML = '';
            }
        });

    </script>
</body>
</html>