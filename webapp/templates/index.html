<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Chart Viewer</title>
    <!-- Include Plotly.js from a CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 40px auto; max-width: 800px; line-height: 1.6; color: #333; }
        h1 { text-align: center; }
        .search-container { position: relative; margin-bottom: 20px; }
        #stock-search { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
        #suggestions { position: absolute; border: 1px solid #ddd; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; }
        #suggestions div { padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #ddd; }
        #suggestions div:hover { background-color: #f1f1f1; }
        #chart { width: 100%; height: 500px; }
        #chart-container { position: relative; }
        #actions-container { position: absolute; bottom: 80px; /* Adjust based on Plotly's x-axis height */ left: 60px; /* Adjust based on Plotly's y-axis width */ right: 20px; height: 30px; z-index: 10; pointer-events: none; }
        .action-marker { position: absolute; bottom: 0; width: 20px; height: 20px; background-color: #e0e0e0; border: 1px solid #999; border-radius: 50%; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; cursor: pointer; pointer-events: all; }
        .action-marker:hover .tooltip { display: block; }
        .action-marker .tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 5px; border-radius: 4px; font-size: 12px; white-space: nowrap; z-index: 11; margin-bottom: 5px; }
        #selected-symbols-container { margin-bottom: 15px; }
        #selected-symbols-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        #selected-symbols .symbol-tag { display: inline-flex; align-items: center; padding: 5px 10px; background-color: #e0e0e0; border-radius: 15px; margin-right: 5px; margin-bottom: 5px; font-size: 14px; }
        #selected-symbols .close-btn { margin-left: 8px; border: none; background: #bbb; color: white; border-radius: 50%; width: 18px; height: 18px; line-height: 18px; text-align: center; cursor: pointer; font-size: 12px; padding: 0; }
        #selected-symbols .close-btn:hover { background: #999; }
        #clear-chart { padding: 8px 12px; border: none; background-color: #f44336; color: white; border-radius: 5px; cursor: pointer; }
        #clear-chart:hover { background-color: #d32f2f; }
        #calculator-container .form-group { margin-bottom: 15px; }
        #calculator-container label { display: block; margin-bottom: 5px; }
        #calculator-container input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #calculator-container button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        #calculator-container button:hover { background-color: #0056b3; }
        #calculator-result { padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        #calculator-result p { margin: 0 0 10px; }
        #calculator-result .label { font-weight: bold; }
    </style>
</head>
<body>
    <h1>Stock Chart Viewer</h1>
    <div class="search-container">
        <input type="text" id="stock-search" placeholder="Type a stock symbol (e.g., TCS)...">
        <div id="suggestions"></div>
    </div>

    <div id="selected-symbols-container">
        <div id="selected-symbols"></div>
        <button id="clear-chart" style="display:none;">Clear Chart</button>
    </div>

    <div id="chart-container">
        <div id="chart"></div>
        <div id="actions-container"></div>
    </div>

    <hr style="margin: 40px 0;">

    <div id="calculator-container">
        <h2>Investment Return Calculator</h2>
        <form id="calculator-form">
            <div class="form-group">
                <label for="calc-stock-symbol">Stock Symbol:</label>
                <input type="text" id="calc-stock-symbol" required>
            </div>
            <div class="form-group">
                <label for="calc-amount">Investment Amount (INR):</label>
                <input type="number" id="calc-amount" min="1" required>
            </div>
            <div class="form-group">
                <label for="calc-date">Investment Date:</label>
                <input type="date" id="calc-date" required>
            </div>
            <button type="submit">Calculate</button>
        </form>
        <div id="calculator-result" style="margin-top: 20px;">
            <!-- Results will be populated here by JavaScript -->
        </div>
    </div>

    <style>
        .result-table { width: 100%; border-collapse: collapse; }
        .result-table td { padding: 8px; border: 1px solid #ddd; }
        .result-table td:first-child { font-weight: bold; width: 40%; }
    </style>

    <script>
        const searchInput = document.getElementById('stock-search');
        const suggestionsContainer = document.getElementById('suggestions');
        const selectedSymbolsContainer = document.getElementById('selected-symbols');
        const clearChartBtn = document.getElementById('clear-chart');
        const chartDiv = document.getElementById('chart');

        let plottedSymbols = [];
        let currentChartData = [];

        // Debounce function to limit API calls
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function updateSelectedSymbolsUI() {
            selectedSymbolsContainer.innerHTML = '';
            plottedSymbols.forEach(symbol => {
                const tag = document.createElement('div');
                tag.className = 'symbol-tag';
                tag.innerHTML = `<span>${symbol}</span><button class="close-btn" data-symbol="${symbol}">&times;</button>`;
                selectedSymbolsContainer.appendChild(tag);
            });
            clearChartBtn.style.display = plottedSymbols.length > 0 ? 'inline-block' : 'none';
        }

        function renderActionMarkers() {
            const actionsContainer = document.getElementById('actions-container');
            actionsContainer.innerHTML = ''; // Clear existing markers

            if (!chartDiv._fullLayout || !chartDiv._fullLayout.xaxis || plottedSymbols.length !== 1) {
                return;
            }

            const xaxis = chartDiv._fullLayout.xaxis;
            const margin = chartDiv._fullLayout.margin;

            actionsContainer.style.left = `${margin.l}px`;
            actionsContainer.style.bottom = `${margin.b}px`;
            actionsContainer.style.width = `${xaxis._length}px`;

            currentChartData.forEach(d => {
                if (d.action_type) {
                    const action = d.action_type.toLowerCase();
                    let markerText = '';
                    let tooltipText = '';

                    if (action === 'dividend') {
                        markerText = 'D';
                        tooltipText = `Dividend: ${d.value} on ${d.date}`;
                    } else if (action === 'split' || action === 'bonus') {
                        markerText = 'S';
                        tooltipText = `${d.action_type}: ${d.value} on ${d.date}`;
                    }

                    if (markerText) {
                        const dateTimestamp = new Date(d.date).getTime();
                        const rangeStart = new Date(xaxis.range[0]).getTime();
                        const rangeEnd = new Date(xaxis.range[1]).getTime();

                        if (dateTimestamp >= rangeStart && dateTimestamp <= rangeEnd) {
                            const pixelX = xaxis.l2p(dateTimestamp);
                            if (pixelX !== undefined) {
                                const marker = document.createElement('div');
                                marker.className = 'action-marker';
                                marker.style.left = `${pixelX - 10}px`;
                                marker.textContent = markerText;

                                const tooltip = document.createElement('span');
                                tooltip.className = 'tooltip';
                                tooltip.textContent = tooltipText;

                                marker.appendChild(tooltip);
                                actionsContainer.appendChild(marker);
                            }
                        }
                    }
                }
            });
        }

        // Function to fetch and display the chart(s)
        async function plotChart() {
            document.getElementById('actions-container').innerHTML = '';
            currentChartData = [];

            if (plottedSymbols.length === 0) {
                Plotly.purge(chartDiv);
                updateSelectedSymbolsUI();
                return;
            }

            const traces = [];
            let layout;
            const config = { scrollZoom: true };

            try {
                if (plottedSymbols.length === 1) {
                    const symbol = plottedSymbols[0];
                    const response = await fetch(`/api/ohlc?symbol=${symbol}`);
                    const data = await response.json();
                    currentChartData = data;

                    if (data.length > 0) {
                        traces.push({
                            x: data.map(d => d.date),
                            open: data.map(d => d.open),
                            high: data.map(d => d.high),
                            low: data.map(d => d.low),
                            close: data.map(d => d.close),
                            type: 'candlestick', name: symbol
                        });
                    }

                    layout = {
                        title: `${symbol} Candlestick Chart`,
                        xaxis: { title: 'Date', rangeslider: { visible: false } },
                        yaxis: { title: 'Price', range: [0, null] },
                        dragmode: 'pan'
                    };

                } else {
                    for (const symbol of plottedSymbols) {
                        const response = await fetch(`/api/ohlc?symbol=${symbol}`);
                        const data = await response.json();
                        if (data.length > 0) {
                            traces.push({
                                x: data.map(d => d.date),
                                y: data.map(d => d.close),
                                type: 'scatter', mode: 'lines', name: symbol
                            });
                        }
                    }
                    layout = {
                        title: `Stock Price Comparison`,
                        xaxis: { title: 'Date' },
                        yaxis: { title: 'Price', range: [0, null] },
                        dragmode: 'pan',
                        showlegend: true
                    };
                }

                if (traces.length === 0) {
                    chartDiv.innerHTML = `<p>No data found for selected symbols.</p>`;
                    return;
                }

                Plotly.newPlot(chartDiv, traces, layout, config).then(() => {
                    renderActionMarkers();
                });
                updateSelectedSymbolsUI();

                chartDiv.on('plotly_relayout', renderActionMarkers);

            } catch (error) {
                console.error('Error fetching chart data:', error);
                chartDiv.innerHTML = '<p>Error loading chart data.</p>';
            }
        }

        // Function to handle search input
        const onSearchInput = async (event) => {
            const query = event.target.value;
            suggestionsContainer.innerHTML = '';

            if (query.length < 2) return;

            try {
                const response = await fetch(`/api/search?q=${query}`);
                const suggestions = await response.json();

                suggestions.forEach(symbol => {
                    const div = document.createElement('div');
                    div.textContent = symbol;
                    div.addEventListener('click', () => {
                        searchInput.value = ''; // Clear search input
                        suggestionsContainer.innerHTML = '';

                        // Also populate the calculator's input field for convenience
                        document.getElementById('calc-stock-symbol').value = symbol;

                        if (plottedSymbols.length < 3 && !plottedSymbols.includes(symbol)) {
                            plottedSymbols.push(symbol);
                            plotChart();
                        } else if (plottedSymbols.length >= 3) {
                            alert("You can compare a maximum of 3 symbols.");
                        }
                    });
                    suggestionsContainer.appendChild(div);
                });
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        };

        clearChartBtn.addEventListener('click', () => {
            plottedSymbols = [];
            Plotly.purge(chartDiv);
            updateSelectedSymbolsUI();
        });

        searchInput.addEventListener('input', debounce(onSearchInput, 300));

        selectedSymbolsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('close-btn')) {
                const symbolToRemove = event.target.dataset.symbol;
                plottedSymbols = plottedSymbols.filter(s => s !== symbolToRemove);
                plotChart();
            }
        });

        document.addEventListener('click', (event) => {
            if (!suggestionsContainer.contains(event.target) && event.target !== searchInput) {
                suggestionsContainer.innerHTML = '';
            }
        });

        const calculatorForm = document.getElementById('calculator-form');
        const calculatorResultDiv = document.getElementById('calculator-result');

        calculatorForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            calculatorResultDiv.innerHTML = '<p>Calculating...</p>';

            const symbol = document.getElementById('calc-stock-symbol').value;
            const amount = document.getElementById('calc-amount').value;
            const date = document.getElementById('calc-date').value;

            try {
                const response = await fetch('/api/calculate_investment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol, amount, date }),
                });

                const result = await response.json();

                if (response.ok) {
                    calculatorResultDiv.innerHTML = `
                        <table class="result-table">
                            <tr><td>Initial Investment</td><td>₹${result.initial_investment.toLocaleString()}</td></tr>
                            <tr><td>Final Value</td><td>₹${result.final_value.toLocaleString()}</td></tr>
                            <tr><td>Investment Period</td><td>${result.start_date} to ${result.end_date}</td></tr>
                            <tr><td>Starting Price</td><td>₹${result.start_price.toFixed(2)}</td></tr>
                            <tr><td>Ending Price</td><td>₹${result.end_price.toFixed(2)}</td></tr>
                            <tr><td>Total Dividends</td><td>₹${result.total_dividends.toLocaleString()}</td></tr>
                            <tr><td>CAGR</td><td>${result.cagr}%</td></tr>
                        </table>
                    `;
                } else {
                    calculatorResultDiv.innerHTML = `<p style="color: red;">Error: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('Calculator error:', error);
                calculatorResultDiv.innerHTML = `<p style="color: red;">An unexpected error occurred. Please check the console.</p>`;
            }
        });
    </script>
</body>
</html>